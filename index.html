<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="demo.css">
    <title>Cognitive API Demo</title>
</head>
<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<!-- jquery랑 자바스크립트를 사용하기 위해서 설치하자~ -->

<canvas id="myCanvas" width="1000" height="500">
    <!-- API를 이용하려면 서버에 보내는 사진의 크기와 웹에 띄워야 할 사진의 크기가 정확히 일치해야 한다.
         그러므로 Canvas 크기와 아래 drawImage 부분에 사이즈를 적절히 지정해 주자. (실전에서는) -->
</canvas>
<div class="filebox">
    <!-- 서버로 전송해줄 것이기 때문에 form tag 사용 -->
    <form enctype="multipart/form-data" action="" id="form" method="POST">
        <input type="hidden" name="MAX_FILE_SIZE" value="30000000"> <!-- file size check 30MB 이하만 -->
        <input type="file" id="input" name="userfile">
        <label for="input">사진 선택</label>
    </form>
</div>

<script>
    var canvas = document.getElementById('myCanvas');
    //canvas라는 변수를 만들어서 mycanvas라는 아이디를 가진 태그의 값을 가져온다.
    var ctx = canvas.getContext('2d');
    //ctx라는 변수에 canvas를 2d로 지정한다는 값을 저장합니다.
    var upload = document.getElementById('input');
    //upload라는 변수에 input아이디를 가진 인풋 태그의 값을 가져온다.
    var img = new Image();
    //img변수에 html에 img태그를 넣을 수 있게 image함수를 만들어 준다.
    var filename = null;
    // filename이란  변수에 null값을 넣어준다. null = 객체 값이 존재하지 않음
    var fullPathName = "http://localhost:8080/MSCogdemo/";
    // fullpathname 변수에 현재 만든 애져의 url을 넣어준다. 나중에 업로드한 파일을 불러올때 필요하다.
    var form = document.getElementById('form');
    // form 태그를 값을 불러온다. 
    var emotion = {
        0: "anger",
        1: "contempt",
        2: "disgust",
        3: "fear",
        4: "happiness",
        5: "neutral",
        6: "sadness",
        7: "surprise"
    };
    // emotion이라는 객체를 만들어서 숫자(key)에 대응하는 감정(value)를 넣어준다
    var emotionImage = new Array(8);
    //크기가 8인 배열 생성

    for (i = 0; i < emotionImage.length; i++)
    {
        emotionImage[i] = new Image();
        emotionImage[i].src = fullPathName + emotion[i] + ".png";
    }
    // i값이 emotionimage배열의 길이만큼까지 증가하면서 emotionimage 배열에 하나씩 새로운 이미지 객체를 정의해준다. 또 이미지 객체에 fullpathname과 감정번호 그리고 사진파일 형식을 붙혀서 넣어준다.

    form.onchange = function(e) {
        img.src = URL.createObjectURL(e.target.files[0]);
    };
    //form tag에 onchange이벤트(객체안의 내용이 바뀌고)가 발생했을 때 img에 url을 지정해 준다. e라는 인자가 들어왔을때..?

    /* Blob는 Binary Large Objects의 약자로 “대용량 바이너리 객체”쯤으로 해석할 수 있다. 이름 그대로 이미지, 동영상 등 단순 텍스트 데이터가 아닌 바이너리 데이터를 담을 수 있는 객체이다. HTML5에 들어서면서 자바스크립트에서도 이러한 파일을 다루어야 할 필요성이 생겨 File API 명세에 정의되었다.*/

    
    // 여기서부터 img가 로드되었을 때 실행되는 콜백함수
    img.onload = function()
    {
        ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, img.width, img.height);
        //ctx변수에 drawimage함수?를 사용하여 좌표 0.0부터 이미지 너비 높이를 지정하고 캔버스의 너비도 이미지와 같은 너비와 높이로 지정해준다. 

        //jquery(javascript 라이브러리 코드를 간편화 시켜줌) / 익명함수 [function() { }]를 실행하라로 해석
        $(function() {
            var form = $('form')[0];
            // form이란 변수에 form tag값을 가져옴(객체로?) == document.getElementByTagName('form')
            
            var fullPath = upload.value;
            //fullpath 변수에 C:\fakepath\DSC00719.JPG 이런식의 가짜 주소를 넣어준다.

            if (fullPath) {
                var startIndex = (fullPath.indexOf('\\') >= 0 ? fullPath.lastIndexOf('\\') : fullPath.lastIndexOf('/'));
                /*조건부 삼항 비교연산자 a ? b : c  a가 true면 b false면 c 
                indexOf() 인자가 몇번째인지, lastIndexOf() 인자가 있는곳에서 뒤에서 맨처음까지 수

                */

                filename = fullPath.substring(startIndex);
                //
                if (filename.indexOf('\\') === 0 || filename.indexOf('/') === 0) {
                    filename = filename.substring(1);
                }
            }

            imgPath = fullPathName;
            imgPath += filename;
            // imgPath에 fullPathName과 filename의 값을 더해준다.



            var formData = new FormData(form);
            //formdata변수에 form객체를 담아준다.

            $.ajax({
                url: './upload.php',
                processData: false,
                contentType: false,
                data: formData,
                type: 'POST',
                success: function()
                {
                   // 필요하면 사용
                }
            });
        });

        $(function() {
            var params = {
                // Request parameters
            };

            $.ajax({
                url: "https://api.projectoxford.ai/emotion/v1.0/recognize?" + $.param(params),
                beforeSend: function(xhrObj){
                    // Request headers
                    xhrObj.setRequestHeader("Content-Type", "application/json");
                    xhrObj.setRequestHeader("Ocp-Apim-Subscription-Key", "EMOTION_API_KEY");
                },
                type: "POST",
                data: "{" +
                "\"url\":\"" + imgPath + "\"}"
                //{" "url": "imgPath" }
            })
                    //여기서 실습할거 추가
                    .done(function(response) {

                        for (i = 0; i < response.length; i++) // JSON 형태라서..
                                // 그냥 Raw data가 보고싶으면 alert(JSON.stringify(response)) 를 해보세요. response가 정의 안되어있는데 뭥미?
                        {
                            var emotionArray = Object.keys(response[i]['scores']).map(function(key) {
                             return parseFloat(response[i]['scores'][key]) 
                         });
                            var maxEmotion = emotionArray.reduce((iMax, x, i, emotionArray) => x > emotionArray[iMax] ? i : iMax, 0);

                            tops = response[i]['faceRectangle'].top;
                            left = response[i]['faceRectangle'].left;
                            width = response[i]['faceRectangle'].width;
                            height = response[i]['faceRectangle'].height;

                            ctx.drawImage(emotionImage[maxEmotion], 0, 0, emotionImage[maxEmotion].width, emotionImage[maxEmotion].height, left, tops, width * 1.1 , height * 1.1);

                            ctx.beginPath();
                            ctx.lineWidth = "6";
                            ctx.strokeStyle = "red";
                            ctx.rect(left, tops, width, height);
                            ctx.stroke();
                        }
                    })

                    .fail(function(response) {
                        alert("Failed response on API server");
                    });
        });
    };
</script>
</body>
</html>